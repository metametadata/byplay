<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><link href="css/default.css" rel="stylesheet" type="text/css" /><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>byplay.core documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Byplay</span> <span class="project-version">0.1.0</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1 current"><a href="byplay.core.html"><div class="inner"><span>byplay.core</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="byplay.core.html#var-job-state-done"><div class="inner"><span>job-state-done</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-job-state-failed"><div class="inner"><span>job-state-failed</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-job-state-new"><div class="inner"><span>job-state-new</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-migrate"><div class="inner"><span>migrate</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-new-worker"><div class="inner"><span>new-worker</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-queue-clj-.3Esql"><div class="inner"><span>queue-clj-&gt;sql</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-queue-sql-.3Eclj"><div class="inner"><span>queue-sql-&gt;clj</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-rollback"><div class="inner"><span>rollback</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-schedule"><div class="inner"><span>schedule</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-schedule-to"><div class="inner"><span>schedule-to</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-work-once"><div class="inner"><span>work-once</span></div></a></li><li class="depth-1"><a href="byplay.core.html#var-WorkerProtocol"><div class="inner"><span>WorkerProtocol</span></div></a></li><li class="depth-2 branch"><a href="byplay.core.html#var-interrupt"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>interrupt</span></div></a></li><li class="depth-2 branch"><a href="byplay.core.html#var-join"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>join</span></div></a></li><li class="depth-2 branch"><a href="byplay.core.html#var-start"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>start</span></div></a></li><li class="depth-2"><a href="byplay.core.html#var-state"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>state</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">byplay.core</h1><div class="doc"><div class="markdown"></div></div><div class="public anchor" id="var-job-state-done"><h3>job-state-done</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Constant for a done job state.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L31">view source</a></div></div><div class="public anchor" id="var-job-state-failed"><h3>job-state-failed</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Constant for a failed job state.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L32">view source</a></div></div><div class="public anchor" id="var-job-state-new"><h3>job-state-new</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Constant for a new job state.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L30">view source</a></div></div><div class="public anchor" id="var-migrate"><h3>migrate</h3><div class="usage"><code>(migrate jdbc-conn)</code></div><div class="doc"><div class="markdown"><p>Creates Byplay’s table and other stuff in the database (if it doesn’t already exist).</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L13">view source</a></div></div><div class="public anchor" id="var-new-worker"><h3>new-worker</h3><div class="usage"><code>(new-worker dbspec config)</code></div><div class="doc"><div class="markdown"><p>Creates several threads for infinitely calling <a href="byplay.core.html#var-work-once">work-once</a> in them with the specified polling interval. Returns a <a href="byplay.core.html#var-WorkerProtocol">WorkerProtocol</a> instance which can be started when needed.</p>
<p><code>dbspec</code> specifies the database connection parameters and has the same format as in <a href="https://funcool.github.io/clojure.jdbc/latest/#connection-parameters">funcool/clojure.jdbc</a>.</p>
<p>Config keys:</p>
<ul>
  <li><code>:queues</code> - vector of queues to poll (order matters), default is <code>nil</code> which means that worker can take a job from any queue</li>
  <li><code>:threads-num</code> - number of worker threads, default is 1</li>
  <li><code>:polling-interval</code> - in msec, default is 5000</li>
  <li><code>:on-fail</code> - a function with signature <code>(on-fail worker exception job-row-map)</code> executed on exception inside a job,  by default it prints a message into stderr</li>
  <li><code>:on-ack</code> - a function <code>(on-ack worker ack)</code> will be executed in child threads with the result of every <a href="byplay.core.html#var-work-once">work-once</a> call. By default does nothing and is mostly useful for testing. If <code>on-fail</code> is specified then in case of a failed job <code>on-ack</code> will be executed after <code>on-fail</code>. You can <code>(.interrupt (Thread/currentThread))</code> in <code>on-ack</code> to stop working in the particular child thread.</li>
</ul></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L217">view source</a></div></div><div class="public anchor" id="var-queue-clj-.3Esql"><h3>queue-clj-&gt;sql</h3><div class="usage"><code>(queue-clj-&gt;sql q-keyword)</code></div><div class="doc"><div class="markdown"><p>Converts the queue name from a Clojure keyword into a string for SQL. The keyword must not have a namespace.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L39">view source</a></div></div><div class="public anchor" id="var-queue-sql-.3Eclj"><h3>queue-sql-&gt;clj</h3><div class="usage"><code>(queue-sql-&gt;clj q-str)</code></div><div class="doc"><div class="markdown"><p>Converts the queue name from a string into a Clojure keyword.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L34">view source</a></div></div><div class="public anchor" id="var-rollback"><h3>rollback</h3><div class="usage"><code>(rollback jdbc-conn)</code></div><div class="doc"><div class="markdown"><p>Removes all Byplay data from the database (if there’s any). Note that library’s empty migrations table will be left in the database.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L20">view source</a></div></div><div class="public anchor" id="var-schedule"><h3>schedule</h3><div class="usage"><code>(schedule jdbc-conn job-var &amp; args)</code></div><div class="doc"><div class="markdown"><p>Puts the job into the queue specified in the job’s metadata at <code>::queue</code>.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L61">view source</a></div></div><div class="public anchor" id="var-schedule-to"><h3>schedule-to</h3><div class="usage"><code>(schedule-to jdbc-conn queue job-var &amp; args)</code></div><div class="doc"><div class="markdown"><p>Puts the job into the specified queue.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L51">view source</a></div></div><div class="public anchor" id="var-work-once"><h3>work-once</h3><div class="usage"><code>(work-once jdbc-conn)</code><code>(work-once jdbc-conn queues)</code></div><div class="doc"><div class="markdown"><p>Low-level API. Processes a single job from one of the queues. The order of the queues matters. If no queues are specified than a job from any queue will be taken.</p>
<p>Returns an <em>ack</em>:</p>
<ul>
  <li><code>nil</code> - if job was not found</li>
  <li>job row map - if job is done, e.g. <code>{:id 123 :state job-state-done :job "app.jobs/some-job" :args "(1 2)" :queue :some-queue}</code></li>
  <li><code>[exception, job row map]</code> - if job has failed</li>
</ul>
<p>Job exception is not rethrown but the job is marked <em>failed</em> instead of <em>done</em>.</p>
<p>Do not call this function inside an already created transaction because <code>work-once</code> will create a new transaction itself. Otherwise, your outer transaction will be prematurely committed because nested transactions are not supported by PostgreSQL.</p></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L133">view source</a></div></div><div class="public anchor" id="var-WorkerProtocol"><h3>WorkerProtocol</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-interrupt"><h3>interrupt</h3><div class="usage"><code>(interrupt _)</code></div><div class="doc"><div class="markdown"><p>Asks the worker to gracefully finish working. Worker will wait for finishing of all currently executed jobs. You can also call <code>join</code> after <code>interrupt</code> to block your thread until worker is stopped. You cannot start the worker again after interruption.</p></div></div></div><div class="public anchor" id="var-join"><h3>join</h3><div class="usage"><code>(join _)</code></div><div class="doc"><div class="markdown"><p>Blocks the current thread until the worker is stopped.</p></div></div></div><div class="public anchor" id="var-start"><h3>start</h3><div class="usage"><code>(start _)</code></div><div class="doc"><div class="markdown"><p>Starts working in background threads.</p></div></div></div><div class="public anchor" id="var-state"><h3>state</h3><div class="usage"><code>(state _)</code></div><div class="doc"><div class="markdown"><p>Returns the current worker state:</p>
<ul>
  <li><code>:new</code></li>
  <li><code>:running</code></li>
  <li><code>:terminated</code></li>
</ul></div></div></div></div></div><div class="src-link"><a href="https://github.com/metametadata/byplay/blob/master/src/byplay/core.clj#L158">view source</a></div></div></div></body></html>