<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Project documentation for Byplay library.">   
    <link rel="shortcut icon" href="./img/favicon.ico">

    <title>Byplay</title>

    <link href="./css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/font-hack/2.018/css/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="./css/base.css" rel="stylesheet">
    <link href="./css/cinder.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/highlight.css">


    <link href="./custom.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>

    
</head>

<body class="homepage" >

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href=".">Byplay</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li class="active">
                        <a href=".">Readme</a>
                    </li>
                
                
                
                    <li >
                        <a href="api/">API Reference</a>
                    </li>
                
                
                
                    <li >
                        <a href="dev-guide/">Developer Guide</a>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li class="disabled">
                        <a rel="next" >
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="api/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/metametadata/byplay/">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

    <div class="container">
        
        <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="first-level active"><a href="#byplay">Byplay</a></li>
        
            <li class="second-level"><a href="#features">Features</a></li>
            
        
            <li class="second-level"><a href="#anti-features">Anti-Features</a></li>
            
        
            <li class="second-level"><a href="#installation">Installation</a></li>
            
        
            <li class="second-level"><a href="#quickstart">Quickstart</a></li>
            
                <li class="third-level"><a href="#initialization">Initialization</a></li>
            
                <li class="third-level"><a href="#job-definition">Job Definition</a></li>
            
                <li class="third-level"><a href="#scheduling">Scheduling</a></li>
            
                <li class="third-level"><a href="#working">Working</a></li>
            
                <li class="third-level"><a href="#shutdown">Shutdown</a></li>
            
        
            <li class="second-level"><a href="#tips">Tips</a></li>
            
                <li class="third-level"><a href="#jobs-should-be-idempotent-whenever-possible">Jobs should be idempotent whenever possible.</a></li>
            
                <li class="third-level"><a href="#use-database-connection-pool-to-speed-things-up">Use database connection pool to speed things up.</a></li>
            
                <li class="third-level"><a href="#job-signatures-are-important">Job signatures are important.</a></li>
            
                <li class="third-level"><a href="#worker-can-throw-exceptions-in-background-threads">Worker can throw exceptions in background threads.</a></li>
            
        
            <li class="second-level"><a href="#documentation">Documentation</a></li>
            
        
            <li class="second-level"><a href="#license">License</a></li>
            
        
    
    </ul>
</div></div>
        <div class="col-md-9" role="main">

<h1 id="byplay">Byplay</h1>
<p>Clojure background job queue on top of PostgreSQL 9.5.</p>
<p>It allows creating background jobs, placing those jobs on multiple queues, and processing them later.
Background jobs can be any named Clojure function.</p>
<p>The project is mostly inspired by <a href="https://github.com/chanks/que">Que</a>,
<a href="https://github.com/resque/resque/">Resque</a> and <a href="https://github.com/celery/celery">Celery</a>.</p>
<p><a href="https://clojars.org/byplay"><img alt="Clojars Project" src="https://img.shields.io/clojars/v/byplay.svg" /></a></p>
<h2 id="features">Features</h2>
<ul>
<li><strong>Durability</strong>: queue can survive app restarts because it is stored inside a PostgreSQL table.
All done and failed jobs are left in a table
so that at any time user is able inspect, retry or purge them manually.</li>
<li><strong>Embedment</strong>: queue consumption worker can be easily started in a background thread.</li>
<li><strong>Parallelism</strong>: queue can be consumed by several threads on different machines to better utilize multiple CPU cores.
The parallel queue consumption is based on a new
<a href="http://blog.2ndquadrant.com/what-is-select-skip-locked-for-in-postgresql-9-5/">FOR UPDATE/SKIP LOCKED</a> feature from PostgreSQL 9.5.</li>
<li><strong>Transactional guarantees</strong>:  <ul>
<li>Every job is executed inside its own database transaction.</li>
<li>If a job is marked <em>done</em> than all its database statements have been committed.</li>
<li>In case of exception inside a job all job's database statements are rolled back 
and a job is marked <em>failed</em>. Thus if a job is marked <em>new</em> or <em>failed</em> then 
none of its database statements have been committed yet.</li>
<li>Scheduling can be executed in a transaction where a data needed for a job is committed.
So that a worker will not pick up the job before the database commits.</li>
</ul>
</li>
<li><strong>Multiple queues</strong>: jobs can be scheduled to different queues/tags.
E.g. you can schedule heavy jobs into a separate "slow" queue/worker 
in order to not block an execution of more important jobs from a "light" queue.</li>
<li><strong>Fewer dependencies</strong>: if you already use PostgreSQL, a separate queue (Redis, RabbitMQ, etc.) is another moving part that can break.</li>
<li><strong>Small</strong>: the implementation with docstrings is less than 300 LOC.</li>
</ul>
<h2 id="anti-features">Anti-Features</h2>
<p>It hasn't been proven yet, but Byplay can experience the problem described in Que docs:</p>
<blockquote>
<p>Que's job table undergoes a lot of churn when it is under high load, and like any heavily-written table, 
is susceptible to bloat and slowness if Postgres isn't able to clean it up. The most common cause of this is 
long-running transactions, so it's recommended to try to keep all transactions against the database housing 
Que's job table as short as possible. This is good advice to remember for any high-activity database, 
but bears emphasizing when using tables that undergo a lot of writes.</p>
</blockquote>
<p>This PostgreSQL issue is explained in more detail in the article 
<a href="https://brandur.org/postgres-queues">"Postgres Job Queues &amp; Failure By MVCC"</a>.</p>
<h2 id="installation">Installation</h2>
<p>Add dependency to your project:</p>
<pre><code class="clj">[byplay &quot;0.4.0&quot;]
</code></pre>

<p>Require a namespace:</p>
<pre><code class="clj">(ns my-app.core
  (:require
    [byplay.core :as b]
    ,,,))
</code></pre>

<h2 id="quickstart">Quickstart</h2>
<h3 id="initialization">Initialization</h3>
<p>On your app start setup Byplay table and the accompanying indexes in the database (it's safe to call this function more than once):</p>
<pre><code class="clj">(b/migrate jdbc-conn)
</code></pre>

<p>Here <code>jdbc-conn</code> is a "raw" <a href="https://en.wikipedia.org/wiki/Java_Database_Connectivity">JDBC</a> connection.
There are different ways to obtain such instance:</p>
<p>1) Via <a href="https://funcool.github.io/clojure.jdbc/latest/#creating-a-connection">funcool/clojure.jdbc</a> JDBC wrapper:</p>
<pre><code class="clj">(with-open [conn (jdbc.core/connection dbspec)]
  (let [jdbc-conn (jdbc.proto/connection conn)]
    ,,,))
</code></pre>

<p>2) Via <a href="http://clojure-doc.org/articles/ecosystem/java_jdbc/home.html#reusing-connections">clojure/java.jdbc</a> JDBC wrapper:</p>
<pre><code class="clj">(clojure.java.jdbc/with-db-connection [conn db-spec]
  (let [jdbc-conn (clojure.java.jdbc/db-connection conn)]
    ,,,))
</code></pre>

<p>3) Via JDBC datasource (e.g. <a href="https://github.com/tomekw/hikari-cp#postgresql-example">HikariCP</a>):</p>
<pre><code class="clj">(with-open [jdbc-conn (.getConnection datasource)]
    ,,,)
</code></pre>

<h3 id="job-definition">Job Definition</h3>
<p>Define a job function:</p>
<pre><code class="clj">(defn my-job
  [ctx x y z]
  (do-something-in-job-transaction1 (:jdbc-conn ctx))

  ; or if you use funcool/clojure.jdbc JDBC wrapper:
  (do-something-in-job-transaction2 (:conn ctx))
  ,,,)
</code></pre>

<p>Here <code>(:jdbc-conn ctx)</code> is a JDBC connection with the current transaction in progress and
<code>(:conn ctx)</code> is the same connection wrapped by <a href="https://funcool.github.io/clojure.jdbc/latest/#connection-parameters">funcool/clojure.jdbc</a>
connection instance.</p>
<h3 id="scheduling">Scheduling</h3>
<p>Put the job into <code>:default</code> queue:</p>
<pre><code class="clj">(b/schedule jdbc-conn #'my-job 1 2 3)
</code></pre>

<p>Explicitly specify another queue using <code>schedule-to</code>:</p>
<pre><code class="clj">(b/schedule-to jdbc-conn :my-queue #'my-job 1 2 3)
</code></pre>

<p>Or specify the queue in the job metadata at <code>:byplay.core/queue</code> key:</p>
<pre><code class="clj">(defn ^{::b/queue :my-queue} my-job
  [ctx x y z]
  ,,,)

(b/schedule jdbc-conn #'my-job 1 2 3)
</code></pre>

<h3 id="working">Working</h3>
<p>Define an instance of <a href="https://funcool.github.io/clojure.jdbc/latest/#connection-parameters">funcool/clojure.jdbc</a> 
database specification, e.g.:</p>
<pre><code class="clj">(def dbspec {:classname   &quot;org.postgresql.Driver&quot;
             :subprotocol &quot;postgresql&quot;
             :subname     &quot;//localhost:5432/myapp&quot;})
</code></pre>

<p>Start a background worker with 2 concurrent work threads, each polling the specified queue for a new job every 5 seconds: </p>
<pre><code class="clj">(b/start (b/new-worker dbspec {:threads-num      2
                               :queues           [:my-queue]
                               :polling-interval 5000
                               :on-fail          (fn on-fail
                                                   [worker exc {:keys [id job args queue state] :as _job}]
                                                   ,,,)}))
</code></pre>

<p><code>on-fail</code> function will be called if exception is thrown from the job.</p>
<h3 id="shutdown">Shutdown</h3>
<p>You can ask a worker to finish all currently running jobs and stop polling a database with <code>interrupt</code> method.
For example this is how a worker can be gracefully stopped in 
<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/Runtime.html#addShutdownHook(java.lang.Thread)">the application shutdown hook</a>:</p>
<pre><code class="clj">(.addShutdownHook (Runtime/getRuntime)
                      (Thread. #(do
                                 ; stop the worker before other services (to not break jobs in progress)
                                 (doto worker b/interrupt b/join)

                                 ; stop other services
                                 ,,,)))
</code></pre>

<h2 id="tips">Tips</h2>
<h3 id="jobs-should-be-idempotent-whenever-possible">Jobs should be idempotent whenever possible.</h3>
<p>Because in rare cases a job may be started more than once.
E.g. a worker may die in the middle of a job execution leaving this job in <em>new</em> state.</p>
<p>Thanks to transactional guarantees, if job only updates the database then you don't have to worry about this problem.
Just don't forget to use a connection from the job context. </p>
<h3 id="use-database-connection-pool-to-speed-things-up">Use database connection pool to speed things up.</h3>
<p>See <a href="https://funcool.github.io/clojure.jdbc/latest/#connection-pool">funcool/clojure.jdbc docs</a>.
Otherwise Byplay will create a new connection to the database on every poll.</p>
<h3 id="job-signatures-are-important">Job signatures are important.</h3>
<p>If you schedule a job and than rename its namespace/function than worker won't find the job var and will fail the task.
Also be careful with changing job args.</p>
<h3 id="worker-can-throw-exceptions-in-background-threads">Worker can throw exceptions in background threads.</h3>
<p>It is possible that an exception can occur in the worker thread outside of a job function.
By default such exceptions silently kill a background thread. So it's a good practice to be ready to explicitly detect them with
<a href="https://stuartsierra.com/2015/05/27/clojure-uncaught-exceptions">Thread/setDefaultUncaughtExceptionHandler</a>.</p>
<h2 id="documentation">Documentation</h2>
<p>More information can be found at <a href="http://metametadata.github.io/byplay/">the project site</a>:</p>
<ul>
<li><a href="http://metametadata.github.io/byplay/api/">API Reference</a></li>
<li><a href="http://metametadata.github.io/byplay/dev-guide/">Developer Guide</a></li>
</ul>
<h2 id="license">License</h2>
<p>Copyright © 2016 Yuri Govorushchenko.</p>
<p>Released under an MIT license.</p></div>
        
    </div>

    <footer class="col-md-12 text-center">
        <hr>
        <p>
        <small>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p></small>
    </footer>

    <script src="./js/jquery-1.10.2.min.js"></script>
    <script src="./js/bootstrap-3.0.3.min.js"></script>
    <script src="./js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>
    var base_url = '.';
    </script>
    <script data-main="./mkdocs/js/search.js" src="./mkdocs/js/require.js"></script>
    <script src="./js/base.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                </div>
                <div class="modal-body">
                    <p>
                        From here you can search these documents. Enter your search terms below.
                    </p>
                    <form role="form">
                        <div class="form-group">
                            <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                        </div>
                    </form>
                    <div id="mkdocs-search-results"></div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>

    </body>

</html>

<!--
MkDocs version : 0.15.3
Build Date UTC : 2016-09-02 14:35:29.906555
-->
